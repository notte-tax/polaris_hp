<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ご購入手続き - Polaris</title>

    <!-- ファビコンの追加 -->
    <link rel="icon" type="image/png" href="Polaris-Logo.png">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Google Fonts: Shippori Mincho -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Shippori+Mincho:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body {
            font-family: 'Shippori Mincho', serif;
            color: #333333;
            background-color: #fdfcfa;
        }
        h1, h2, h3, h4, h5, h6 {
            font-weight: 500;
            letter-spacing: 0.05em;
        }
        .btn-primary {
            background-color: #E6A4B4;
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(230, 164, 180, 0.3);
        }
        .btn-primary:hover {
            background-color: #D988A3;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(217, 136, 163, 0.4);
        }
        .btn-secondary {
            background-color: #f0f0f0;
            color: #333;
            transition: background-color 0.3s;
        }
        .btn-secondary:hover {
            background-color: #e0e0e0;
        }
        .btn-secondary:disabled {
            background-color: #e0e0e0;
            cursor: not-allowed;
        }
        .quantity-btn {
            background-color: #f0f0f0;
            transition: background-color 0.2s;
        }
        .quantity-btn:hover {
            background-color: #e0e0e0;
        }

        /* Footer Video Background */
        .video-container {
            position: relative;
            width: 100%;
            overflow: hidden;
            background-color: #000;
            z-index: 0;
        }
        .video-container video {
            position: absolute;
            top: 50%;
            left: 50%;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            transform: translateX(-50%) translateY(-50%);
            z-index: -1;
            object-fit: cover;
        }
        .video-container .video-overlay {
            position: absolute;
            inset: 0;
            z-index: 0;
        }
        footer.video-container .video-overlay {
            background-color: rgba(25, 25, 35, 0.8);
        }
        footer .footer-content {
            position: relative;
            z-index: 1;
        }

        /* ヘッダーのスタイル（cart.htmlと同じ） */
        #header.scrolled .nav-link,
        #header.scrolled .nav-link i,
        #header.scrolled .nav-link .cart-item-count {
            color: #555555;
            text-shadow: none;
        }
        #hamburger-btn { position: relative; z-index: 60; }
        .hamburger-active .top-line {
            transform: rotate(45deg) translate(5px, 6px);
            background-color: #333;
        }
        .hamburger-active .middle-line {
            opacity: 0;
        }
        .hamburger-active .bottom-line {
            transform: rotate(-45deg) translate(5px, -6px);
            background-color: #333;
        }
        #header .hamburger-line {
            transition: background-color 0.4s ease-out, transform 0.3s ease-in-out, opacity 0.3s ease-in-out;
            background-color: #333333;
            width: 32px;
            height: 2px;
        }
        #mobile-menu {
            position: fixed;
            top: 0;
            left: 0;
            width: 80%;
            max-width: 300px;
            height: 100vh;
            background-color: rgba(255, 255, 255, 0.98);
            z-index: 55;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            transform: translateX(-100%);
            transition: transform 0.4s cubic-bezier(0.86, 0, 0.07, 1);
        }
        #mobile-menu.open {
            transform: translateX(0);
        }
        #mobile-menu a {
            font-size: 1.25rem;
            margin: 1.25rem 0;
            color: #555;
        }

        /* フォーム要素のスタイル */
        .form-input {
            width: 100%;
            padding: 0.75rem;
            border-radius: 0.375rem;
            border: 1px solid #ccc;
            outline: none;
            transition: border-color 0.2s;
        }
        .form-input:focus {
            border-color: #E6A4B4;
        }
        .form-label {
            font-weight: 500;
            color: #555555;
            display: block;
            margin-bottom: 0.5rem;
        }
        .payment-option input[type="radio"] {
            display: none;
        }
        .payment-option label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 1rem;
            border: 1px solid #e0e0e0;
            border-radius: 0.5rem;
            transition: all 0.2s ease;
            background-color: white;
        }
        .payment-option input[type="radio"]:checked + label {
            border-color: #E6A4B4;
            background-color: #fffaf0;
            box-shadow: 0 0 5px rgba(230, 164, 180, 0.3);
        }
        .payment-option label:hover {
            border-color: #E6A4B4;
        }
        .payment-option label .checkmark {
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 50%;
            border: 2px solid #aaa;
            display: inline-block;
            position: relative;
            margin-right: 1rem;
            flex-shrink: 0;
        }
        .payment-option input[type="radio"]:checked + label .checkmark {
            border-color: #E6A4B4;
            background-color: #E6A4B4;
        }
        .payment-option input[type="radio"]:checked + label .checkmark::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 8px;
            height: 8px;
            background-color: white;
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        .required::after {
            content: "必須";
            margin-left: 0.5rem;
            background-color: #E6A4B4;
            color: white;
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 9999px;
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        /* クレジットカード情報の入力欄のスタイル */
        .payment-info-box {
            display: none;
            margin-top: 1rem;
            padding: 1rem;
            background-color: #f7f5f3;
            border-radius: 0.5rem;
        }
        .payment-info-box.visible {
            display: block;
        }
        .form-section {
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .form-section h2 {
            margin-top: 0;
        }

        /* ローディングモーダルのスタイル */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.visible {
            visibility: visible;
            opacity: 1;
        }
        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #E6A4B4;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ページトップボタンのスタイル */
        #page-top-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 50px;
            height: 50px;
            background-color: #E6A4B4;
            color: white;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s, transform 0.3s;
            z-index: 50;
            transform: translateY(20px);
        }
        #page-top-btn.visible {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }
        #page-top-btn:hover {
            background-color: #D988A3;
            transform: translateY(-2px);
        }
    </style>
</head>
<body class="bg-fdfcfa">

    <!-- Header -->
    <header id="header" class="sticky top-0 bg-white/80 backdrop-blur-lg z-50 shadow-sm">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html" class="flex items-center">
                <img src="Polaris-Logo.png" alt="Polaris Logo" class="h-12 mr-2" onerror="this.onerror=null;this.src='https://placehold.co/48x48/ffffff/E6A4B4?text=P';">
                <span class="text-2xl font-bold text-gray-800">Polaris</span>
            </a>
            <nav class="hidden md:flex items-center space-x-8">
                <a href="index.html#concept" class="text-gray-600 hover:text-[#E6A4B4] transition-colors">ボディートークとは</a>
                <a href="index.html#service" class="text-gray-600 hover:text-[#E6A4B4] transition-colors">セッションの流れ</a>
                <a href="pricing.html" class="text-gray-600 hover:text-[#E6A4B4] transition-colors">料金</a>
                <a href="index.html#column" class="text-gray-600 hover:text-[#E6A4B4] transition-colors">コラム</a>
                <a href="coming-soon.html" class="text-gray-600 hover:text-[#E6A4B4] transition-colors">商品一覧</a>
                <a href="contact.html" class="text-gray-600 hover:text-[#E6A4B4] transition-colors">お問い合わせ</a>
                <a href="cart.html" class="text-[#E6A4B4] font-bold relative">
                    <i class="fas fa-shopping-cart"></i>
                    <span class="cart-item-count absolute -top-2 -right-3 bg-[#E6A4B4] text-white text-xs rounded-full h-5 w-5 flex items-center justify-center" style="display: none;">0</span>
                </a>
            </nav>
            <div class="md:hidden flex items-center gap-4">
                <a href="cart.html" class="text-[#333333] hover:text-[#E6A4B4] transition-colors relative">
                    <i class="fas fa-shopping-cart text-xl"></i>
                    <span class="cart-item-count absolute -top-2 -right-3 bg-[#E6A4B4] text-white text-xs rounded-full h-5 w-5 flex items-center justify-center" style="display: none;">0</span>
                </a>
                <button id="hamburger-btn" class="z-50 space-y-1.5">
                    <div class="hamburger-line top-line"></div>
                    <div class="hamburger-line middle-line"></div>
                    <div class="hamburger-line bottom-line"></div>
                </button>
            </div>
        </div>
    </header>

    <!-- モバイルメニューのHTML -->
    <div id="mobile-menu">
        <a href="index.html#concept" class="hover:text-[#E6A4B4]">ボディートークとは</a>
        <a href="index.html#service" class="hover:text-[#E6A4B4]">セッションの流れ</a>
        <a href="pricing.html" class="hover:text-[#E6A4B4]">料金</a>
        <a href="index.html#column" class="hover:text-[#E6A4B4]">コラム</a>
        <a href="coming-soon.html" class="hover:text-[#E6A4B4]">商品一覧</a>
        <a href="contact.html" class="hover:text-[#E6A4B4]">お問い合わせ</a>
        <a href="cart.html" class="text-[#E6A4B4] font-bold">カート</a>
    </div>

    <main>
        <section class="py-16 md:py-24" style="background: linear-gradient(180deg, #fdfcfa 0%, #fff 100%);">
            <div class="container mx-auto px-6">
                <h1 class="text-3xl md:text-4xl font-bold text-center text-gray-800 mb-12">ご購入手続き</h1>

                <form id="checkout-form" class="max-w-xl mx-auto space-y-8">
                    <!-- 注文内容の確認 -->
                    <div class="form-section">
                        <h2 class="text-2xl font-bold mb-6 border-b pb-2">ご注文内容の確認</h2>
                        <div id="checkout-summary" class="bg-gray-50 p-6 rounded-lg">
                            <div id="checkout-items" class="border-b mb-4 pb-4">
                                <!-- カート内の商品がここに表示されます -->
                            </div>
                            <div class="flex justify-between mb-2">
                                <span class="text-gray-600">小計</span>
                                <span id="subtotal" class="font-bold">¥0</span>
                            </div>
                            <div class="flex justify-between mb-4">
                                <span class="text-gray-600">送料</span>
                                <span id="shipping-fee" class="font-bold">¥0</span>
                            </div>
                            <div class="flex justify-between font-bold text-xl border-t pt-4">
                                <span>合計</span>
                                <span id="total" class="text-[#E6A4B4]">¥0</span>
                            </div>
                        </div>
                    </div>

                    <!-- お届け先情報 -->
                    <div class="form-section">
                        <h2 class="text-2xl font-bold mb-6 border-b pb-2">お届け先情報</h2>
                        
                        <div class="mb-4">
                            <label for="name" class="form-label required">お名前</label>
                            <input type="text" id="name" name="name" class="form-input" placeholder="山田 太郎" required>
                            <p class="error-message" id="name-error">お名前を入力してください。</p>
                        </div>

                        <div class="mb-4">
                            <label for="kana" class="form-label required">フリガナ</label>
                            <input type="text" id="kana" name="kana" class="form-input" placeholder="ヤマダ タロウ" required>
                            <p class="error-message" id="kana-error">フリガナを入力してください。</p>
                        </div>
                        
                        <div class="mb-4">
                            <label for="postalCode" class="form-label required">郵便番号</label>
                            <div class="flex items-center space-x-2">
                                <input type="text" id="postalCode" name="postalCode" class="form-input w-36" placeholder="123-4567" maxlength="8" required>
                                <button type="button" id="postalCode-search-btn" class="btn-secondary px-4 py-2 rounded-md text-sm whitespace-nowrap">住所を自動入力</button>
                            </div>
                            <p class="error-message" id="postalCode-error">ハイフンを含む7桁の数字（例: 123-4567）で入力してください。</p>
                        </div>
                        
                        <div class="mb-4">
                            <label for="address" class="form-label required">住所</label>
                            <input type="text" id="address" name="address" class="form-input" placeholder="東京都渋谷区広尾1-1-1" required>
                            <p class="error-message" id="address-error">住所を入力してください。</p>
                        </div>
                        
                        <div class="mb-4">
                            <label for="tel" class="form-label required">電話番号</label>
                            <input type="tel" id="tel" name="tel" class="form-input" placeholder="090-1234-5678" required>
                            <p class="error-message" id="tel-error">有効な電話番号を入力してください。</p>
                        </div>

                        <div class="mb-4">
                            <label for="email" class="form-label required">メールアドレス</label>
                            <input type="email" id="email" name="email" class="form-input" placeholder="info@polaris.com" required>
                            <p class="error-message" id="email-error">有効なメールアドレスを入力してください。</p>
                        </div>
                    </div>

                    <!-- お支払い方法 -->
                    <div class="form-section">
                        <h2 class="text-2xl font-bold mb-6 border-b pb-2">お支払い方法</h2>
                        <div class="space-y-4">
                            <div class="payment-option">
                                <input type="radio" id="payment-credit" name="payment" value="credit" checked>
                                <label for="payment-credit">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-credit-card text-xl text-gray-500 mr-4"></i>
                                    <div>
                                        <p class="font-bold">クレジットカード</p>
                                        <p class="text-sm text-gray-500">VISA, Master, JCB, Amex</p>
                                    </div>
                                </label>
                            </div>
                            <!-- クレジットカード情報入力欄 -->
                            <div id="credit-card-info" class="payment-info-box visible">
                                <div class="mb-4">
                                    <label for="cardNumber" class="form-label required">カード番号</label>
                                    <input type="text" id="cardNumber" name="cardNumber" class="form-input" placeholder="0000-0000-0000-0000" required>
                                    <p class="error-message" id="cardNumber-error">有効なカード番号を入力してください。</p>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label for="cardExpiry" class="form-label required">有効期限</label>
                                        <input type="text" id="cardExpiry" name="cardExpiry" class="form-input" placeholder="MM/YY" required>
                                        <p class="error-message" id="cardExpiry-error">有効期限をMM/YY形式で入力してください。</p>
                                    </div>
                                    <div>
                                        <label for="cardCvc" class="form-label required">セキュリティコード</label>
                                        <input type="text" id="cardCvc" name="cardCvc" class="form-input" placeholder="CVC" required>
                                        <p class="error-message" id="cardCvc-error">3桁または4桁の数字で入力してください。</p>
                                    </div>
                                </div>
                            </div>

                            <div class="payment-option">
                                <input type="radio" id="payment-bank" name="payment" value="bank">
                                <label for="payment-bank">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-building-columns text-xl text-gray-500 mr-4"></i>
                                    <div>
                                        <p class="font-bold">銀行振込</p>
                                        <p class="text-sm text-gray-500">お振込確認後に発送いたします</p>
                                    </div>
                                </label>
                            </div>
                            <!-- 銀行振込情報表示欄 -->
                            <div id="bank-transfer-info" class="payment-info-box">
                                <p class="text-sm text-gray-700 mb-2">以下の口座にお振込みください。振込手数料はお客様のご負担となります。</p>
                                <ul class="space-y-1 text-sm text-gray-600">
                                    <li><span class="font-bold">銀行名:</span> ポラリス銀行</li>
                                    <li><span class="font-bold">支店名:</span> 中央支店</li>
                                    <li><span class="font-bold">口座種別:</span> 普通</li>
                                    <li><span class="font-bold">口座番号:</span> 1234567</li>
                                    <li><span class="font-bold">名義:</span> ヤマダ タロウ</li>
                                </ul>
                            </div>

                            <div class="payment-option">
                                <input type="radio" id="payment-cod" name="payment" value="cod">
                                <label for="payment-cod">
                                    <span class="checkmark"></span>
                                    <i class="fas fa-handshake-simple text-xl text-gray-500 mr-4"></i>
                                    <div>
                                        <p class="font-bold">代金引換</p>
                                        <p class="text-sm text-gray-500">手数料が別途発生します</p>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex flex-col sm:flex-row justify-between items-center mt-10 space-y-4 sm:space-y-0 sm:space-x-4">
                        <a href="cart.html" class="btn-secondary py-3 px-6 rounded-md w-full sm:w-auto text-center"><i class="fas fa-arrow-left mr-2"></i>カートに戻る</a>
                        <button type="submit" class="btn-primary py-3 px-6 rounded-md w-full sm:w-auto text-center font-bold">注文を確定する</button>
                    </div>
                </form>
            </div>
        </section>
    </main>
    
    <!-- ローディングモーダル -->
    <div id="loading-modal" class="modal">
        <div class="modal-content">
            <div class="loader"></div>
            <p class="text-lg font-bold text-gray-800">決済処理中...</p>
        </div>
    </div>

    <!-- Footer -->
    <footer class="video-container text-white">
        <video autoplay muted loop playsinline poster="https://images.pexels.com/photos/1252890/pexels-photo-1252890.jpeg?auto=compress&cs=tinysrgb&w=1260&h=750&dpr=1"><source src="https://videos.pexels.com/video-files/3129957/3129957-hd_1920_1080_25fps.mp4" type="video/mp4"></video>
        <div class="video-overlay"></div>
        <div class="footer-content container mx-auto px-6 py-12">
            <div class="text-center">
                <h3 class="text-2xl font-bold mb-4">Polaris</h3>
                <nav class="flex justify-center flex-wrap gap-x-6 gap-y-2 mb-8">
                    <a href="index.html#concept" class="text-gray-300 hover:text-white">ボディートークとは</a>
                    <a href="index.html#service" class="text-gray-300 hover:text-white">セッションの流れ</a>
                    <a href="pricing.html" class="text-gray-300 hover:text-white">料金</a>
                    <a href="index.html#column" class="text-gray-300 hover:text-white">コラム</a>
                    <a href="coming-soon.html" class="text-gray-300 hover:text-white">商品一覧</a>
                    <a href="contact.html" class="text-gray-300 hover:text-white">お問い合わせ</a>
                </nav>
                <div class="mb-6 text-gray-400">
                    <p>サロン住所：北海道札幌市中央区 地下鉄東西線 バスセンター前駅 徒歩2分</p>
                    <p class="text-sm">※詳しくは予約確定後にお伝えします。</p>
                </div>
                <p class="text-sm text-gray-400">&copy; 2024 Polaris. All Rights Reserved.</p>
            </div>
        </div>
    </footer>

    <!-- ページトップボタン -->
    <a href="#" id="page-top-btn">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 15l7-7 7 7"></path></svg>
    </a>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // カートアイコンの更新
            function updateCartIcon() {
                const cart = JSON.parse(localStorage.getItem('polarisCart')) || [];
                const count = cart.reduce((total, item) => total + item.quantity, 0);
                const countElements = document.querySelectorAll('.cart-item-count');
        
                countElements.forEach(element => {
                    if (count > 0) {
                        element.textContent = count;
                        element.style.display = 'flex';
                    } else {
                        element.style.display = 'none';
                    }
                });
            }
            updateCartIcon();

            // ハンバーガーメニューの制御
            const hamburgerBtn = document.getElementById('hamburger-btn');
            const mobileMenu = document.getElementById('mobile-menu');
            if (hamburgerBtn && mobileMenu) {
                hamburgerBtn.addEventListener('click', () => {
                    hamburgerBtn.classList.toggle('hamburger-active');
                    mobileMenu.classList.toggle('open');
                    document.body.style.overflowY = mobileMenu.classList.contains('open') ? 'hidden' : '';
                });
                mobileMenu.addEventListener('click', (e) => {
                     if (e.target.tagName === 'A') {
                        hamburgerBtn.classList.remove('hamburger-active');
                        mobileMenu.classList.remove('open');
                        document.body.style.overflowY = '';
                     }
                });
            }

            // ページトップボタンの制御
            const pageTopBtn = document.getElementById('page-top-btn');
            if (pageTopBtn) {
                window.addEventListener('scroll', () => {
                    if (window.scrollY > 400) {
                        pageTopBtn.classList.add('visible');
                    } else {
                        pageTopBtn.classList.remove('visible');
                    }
                });
                pageTopBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                });
            }

            // フォームとサマリーのレンダリング
            renderOrderSummary();

            // 支払い方法の表示・非表示を切り替える
            const paymentOptions = document.querySelectorAll('input[name="payment"]');
            const creditCardInfo = document.getElementById('credit-card-info');
            const bankTransferInfo = document.getElementById('bank-transfer-info');

            paymentOptions.forEach(option => {
                option.addEventListener('change', (e) => {
                    creditCardInfo.classList.remove('visible');
                    bankTransferInfo.classList.remove('visible');

                    if (e.target.value === 'credit') {
                        creditCardInfo.classList.add('visible');
                    } else if (e.target.value === 'bank') {
                        bankTransferInfo.classList.add('visible');
                    }
                });
            });

            // --- ▼▼▼ 修正箇所 ▼▼▼ ---
            // 郵便番号から住所を自動入力する機能
            const postalCodeInput = document.getElementById('postalCode');
            const addressInput = document.getElementById('address');
            const postalCodeSearchBtn = document.getElementById('postalCode-search-btn');

            postalCodeSearchBtn.addEventListener('click', async () => {
                // ボタンをローディング状態にする
                postalCodeSearchBtn.textContent = '検索中...';
                postalCodeSearchBtn.disabled = true;

                const postalCode = postalCodeInput.value.replace(/-/g, '');
                if (postalCode.length !== 7) {
                    showError('postalCode', '7桁の数字で入力してください。');
                    // ボタンの状態を元に戻す
                    postalCodeSearchBtn.textContent = '住所を自動入力';
                    postalCodeSearchBtn.disabled = false;
                    return;
                }
                hideError('postalCode');
                
                try {
                    // 正しいAPIエンドポイントを使用
                    const response = await fetch(`https://zipcloud.ibsnet.co.jp/api/search?zipcode=${postalCode}`);
                    if (!response.ok) {
                        throw new Error(`ネットワークエラーが発生しました: ${response.status}`);
                    }
                    const data = await response.json();
                    
                    // APIからのレスポンスステータスを確認
                    if (data.status === 200 && data.results) {
                        const result = data.results[0];
                        addressInput.value = `${result.address1}${result.address2}${result.address3}`;
                        hideError('postalCode'); // 成功したらエラーメッセージを消す
                    } else {
                        // 住所が見つからなかった場合のエラーメッセージ
                        showError('postalCode', data.message || '有効な郵便番号ではありません。');
                    }
                } catch (error) {
                    console.error('住所検索APIの呼び出しに失敗しました:', error);
                    showError('postalCode', '住所の自動入力に失敗しました。');
                } finally {
                    // 成功・失敗に関わらずボタンの状態を元に戻す
                    postalCodeSearchBtn.textContent = '住所を自動入力';
                    postalCodeSearchBtn.disabled = false;
                }
            });
            // --- ▲▲▲ 修正箇所 ▲▲▲ ---

            // フォームのバリデーション
            const form = document.getElementById('checkout-form');
            const loadingModal = document.getElementById('loading-modal');

            form.addEventListener('submit', (e) => {
                e.preventDefault();
                
                if (validateForm()) {
                    const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
                    if (paymentMethod === 'credit') {
                        loadingModal.classList.add('visible');
                        // 決済処理をシミュレート
                        setTimeout(() => {
                            localStorage.removeItem('polarisCart');
                            loadingModal.classList.remove('visible');
                            window.location.href = 'order-complete.html';
                        }, 2000);
                    } else {
                        localStorage.removeItem('polarisCart');
                        window.location.href = 'order-complete.html';
                    }
                }
            });

            function validateForm() {
                let isValid = true;
                // 必須フィールドのチェック
                ['name', 'kana', 'postalCode', 'address', 'tel', 'email'].forEach(id => {
                    const input = document.getElementById(id);
                    if (!input.value.trim()) {
                        showError(id, `${input.labels[0].textContent.replace('必須', '').trim()}を入力してください。`);
                        isValid = false;
                    } else {
                        hideError(id);
                    }
                });

                // 各フィールドの形式チェック
                if (!/^\d{3}-?\d{4}$/.test(document.getElementById('postalCode').value.trim())) {
                    showError('postalCode', 'ハイフンを含む7桁の数字（例: 123-4567）で入力してください。');
                    isValid = false;
                }
                if (!/^[0-9-]{10,13}$/.test(document.getElementById('tel').value.trim())) {
                    showError('tel', '有効な電話番号を入力してください。');
                    isValid = false;
                }
                const emailInput = document.getElementById('email');
                if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(emailInput.value.trim())) {
                    showError('email', '有効なメールアドレスを入力してください。');
                    isValid = false;
                }

                // クレジットカード情報のチェック
                const paymentMethod = document.querySelector('input[name="payment"]:checked').value;
                if (paymentMethod === 'credit') {
                    if (!/^\d{4}-?\d{4}-?\d{4}-?\d{4}$/.test(document.getElementById('cardNumber').value.replace(/\s/g, ''))) {
                        showError('cardNumber', '有効なカード番号を入力してください。');
                        isValid = false;
                    } else {
                        hideError('cardNumber');
                    }
                    if (!/^(0[1-9]|1[0-2])\/?([0-9]{2})$/.test(document.getElementById('cardExpiry').value.trim())) {
                        showError('cardExpiry', '有効期限をMM/YY形式で入力してください。');
                        isValid = false;
                    } else {
                        hideError('cardExpiry');
                    }
                    if (!/^\d{3,4}$/.test(document.getElementById('cardCvc').value.trim())) {
                        showError('cardCvc', '3桁または4桁の数字で入力してください。');
                        isValid = false;
                    } else {
                        hideError('cardCvc');
                    }
                }
                return isValid;
            }

            function showError(fieldId, message) {
                const errorElement = document.getElementById(`${fieldId}-error`);
                const inputElement = document.getElementById(fieldId);
                if (errorElement) {
                    errorElement.textContent = message;
                    errorElement.style.display = 'block';
                }
                if (inputElement) {
                    inputElement.style.borderColor = '#ef4444';
                }
            }

            function hideError(fieldId) {
                const errorElement = document.getElementById(`${fieldId}-error`);
                const inputElement = document.getElementById(fieldId);
                if (errorElement) {
                    errorElement.style.display = 'none';
                }
                if (inputElement) {
                    inputElement.style.borderColor = '#ccc';
                }
            }
        });

        function renderOrderSummary() {
            const cart = JSON.parse(localStorage.getItem('polarisCart')) || [];
            const itemsContainer = document.getElementById('checkout-items');
            itemsContainer.innerHTML = '';
            
            let subtotal = 0;
            
            if (cart.length === 0) {
                itemsContainer.innerHTML = '<p class="text-center text-gray-500">カートに商品がありません。</p>';
                document.querySelector('.form-section').style.display = 'none'; // 注文内容全体を非表示
                // 必要であれば、フォーム送信ボタンなども無効化する
                return;
            } else {
                 document.querySelector('.form-section').style.display = 'block';
            }

            cart.forEach(item => {
                const itemTotal = item.price * item.quantity;
                subtotal += itemTotal;
                const itemHTML = `
                    <div class="flex items-start mb-4">
                        <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-contain rounded-md mr-4" onerror="this.onerror=null;this.src='https://placehold.co/64x64/f0f0f0/ccc?text=Image';">
                        <div class="flex-grow">
                            <p class="font-bold text-sm">${item.name}</p>
                            <p class="text-gray-500 text-sm">¥${item.price.toLocaleString()} × ${item.quantity}</p>
                        </div>
                        <p class="font-bold">¥${itemTotal.toLocaleString()}</p>
                    </div>`;
                itemsContainer.insertAdjacentHTML('beforeend', itemHTML);
            });

            const shippingFee = 800;
            const total = subtotal + shippingFee;

            document.getElementById('subtotal').textContent = `¥${subtotal.toLocaleString()}`;
            document.getElementById('shipping-fee').textContent = `¥${shippingFee.toLocaleString()}`;
            document.getElementById('total').textContent = `¥${total.toLocaleString()}`;
        }
    </script>
</body>
</html>
